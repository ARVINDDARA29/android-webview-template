name: Build Android APK

on:
  workflow_dispatch:
    inputs:
      app_name:
        description: 'App name (display)'
        required: true
        type: string
      url:
        description: 'Start URL for WebView (https://...)'
        required: true
        type: string

env:
  GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx1536m"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Show inputs
        run: |
          echo "app_name='${{ github.event.inputs.app_name }}'"
          echo "url='${{ github.event.inputs.url }}'"

      # ---------- Replace placeholders in files ----------
      - name: Replace placeholders in strings.xml & MainActivity
        run: |
          # --- strings.xml: replace APP_NAME placeholder ---
          sed -i "s|APP_NAME_PLACEHOLDER|${{ github.event.inputs.app_name }}|g" app/src/main/res/values/strings.xml || true

          # --- MainActivity: replace APP_URL placeholder ---
          sed -i "s|APP_URL_PLACEHOLDER|${{ github.event.inputs.url }}|g" app/src/main/java/com/example/webview/MainActivity.java || true

          # If you also store config.json, update it (optional)
          printf '{"app_name":"%s","url":"%s"}' "${{ github.event.inputs.app_name }}" "${{ github.event.inputs.url }}" > config.json
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add config.json
          git commit -m "Update config.json for build: ${{ github.run_id }}" || true
          git push || true

      # optional: if you want to sign release APK, decode keystore from secret
      - name: Setup keystore (optional, if KEYSTORE_BASE64 present)
        if: secrets.KEYSTORE_BASE64 != ''
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > android.keystore
          echo "Keystore written to android.keystore"

      - name: Export keystore envs for Gradle (if present)
        if: secrets.KEYSTORE_BASE64 != ''
        run: |
          echo "KEYSTORE_FILE=$(pwd)/android.keystore" >> $GITHUB_ENV
          echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
          echo "KEY_ALIAS=${{ secrets.KEY_ALIAS }}" >> $GITHUB_ENV
          echo "KEY_PASSWORD=${{ secrets.KEY_PASSWORD }}" >> $GITHUB_ENV

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      - name: Build Release APK
        run: ./gradlew assembleRelease --no-daemon

      - name: List built apk files
        run: ls -la app/build/outputs/apk/** || true

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: generated-apk
          path: app/build/outputs/apk/release/*.apk
